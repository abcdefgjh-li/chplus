# .ch 文件中文解释器

## 项目简介

这是一个使用 C++ 实现的 `.ch` 文件中文解释器，直接解析并执行 `.ch` 后缀文件，无需转换为其他语言。解释器采用类 C++ 的编译解析逻辑，所有关键字均使用中文，支持变量定义、函数定义、基本运算、控制台输出、数组操作、结构体、文件操作和流程控制等核心功能。

## 主要功能

- 完整的错误定位系统，所有错误都包含精确的行号信息
- 智能类型系统：整型运算返回整型，浮点数运算返回浮点数
- 一元负号运算符支持
- 函数作用域链支持
- 控制台输入支持（包括数组元素）
- 嵌套if语句支持
- 主函数定义语法支持
- 复合赋值运算符（+=, -=, *=, /=, %=, ^=）
- 自增自减运算符（前缀++x, --x，后置x++, x--）
- 多变量定义、输入、输出功能
- 空定义功能和完整类型推断系统
- 完整的表达式评估和代码生成
- 多维数组支持：支持1-5维数组
- 动态数组大小支持：支持使用变量和表达式作为数组大小
- 文件读写操作：支持文件读取、写入和追加操作
- 结构体定义和成员访问：支持结构体定义、变量实例化和成员访问
- 函数重载：支持同名函数不同参数
- 函数返回类型检查：确保函数返回类型与定义一致
- 完整的流程控制：if-else if-else、while、for循环
- ASCII字符兼容：完全支持ASCII码表和中文字符
- 系统命令行：支持系统命令行执行功能
- 跨平台兼容：支持Windows和Linux系统
- 文件内存存储：支持将变量存储到文件中，实现数据持久化和跨程序共享
- 纯内存存储：支持使用纯内存存储变量，不生成txt文件，支持大数组
- 高精度整数计算：使用BigInt实现任意长度整数运算，支持超大数计算

**Bug反馈**：有bug请tg @abcdefgjha反馈

## 开源协议

本项目采用 **GNU Affero General Public License v3.0 (AGPL v3.0) + Commons Clause 1.0** 协议。

### 核心许可声明

1. 本项目**仅允许个人非商业用途使用**，禁止任何形式的商业使用（包括但不限于：出售、出租、作为商业产品的组件、通过本项目获取商业收益等）。
2. 个人使用者可以自由修改、重构本项目代码，但修改后的衍生作品必须：
   - 遵守本许可证的全部条款（同样禁止商用）
   - 保留原项目的版权信息和许可证文本
   - 以相同的协议开源发布，且必须附带完整的源代码（包括修改记录）
   - 明确标注衍生作品与原项目的差异，并提供原项目的官方源库链接
3. 禁止删除、修改本许可证中的任何条款，禁止隐瞒原项目的作者信息和源库地址。

完整协议文本请查看 [LICENSE](LICENSE) 文件。

## 目录结构

```
chplus/
├── main.cpp              # 主程序入口
├── README.md             # 项目文档
├── LICENSE               # 开源协议
├── core/                 # 核心代码目录
│   ├── lexer.h           # 词法分析器头文件
│   ├── lexer.cpp         # 词法分析器实现
│   ├── parser.h          # 语法分析器头文件
│   ├── parser.cpp        # 语法分析器实现
│   ├── interpreter.h     # 执行器头文件
│   ├── interpreter.cpp   # 执行器实现
│   ├── FileMemory.h      # 文件内存存储头文件
│   ├── FileMemory.cpp    # 文件内存存储实现
│   ├── MemoryStorage.h   # 纯内存存储头文件
│   ├── MemoryStorage.cpp # 纯内存存储实现
│   ├── BigInt.h         # 高精度整数头文件
│   ├── BigInt.cpp       # 高精度整数实现
│   ├── CHFormatter.h     # 中文格式化器头文件
│   ├── CHFormatter.cpp   # 中文格式化器实现
│   ├── CodeFormatter.h   # 代码格式化器头文件
│   ├── CodeFormatter.cpp # 代码格式化器实现
│   └── common.h          # 公共头文件
├── jni/                  # Android JNI 构建配置
│   ├── Android.mk
│   └── Application.mk
├── examples/             # 示例文件目录
│   ├── hello.ch          # Hello World 示例
│   ├── array_demo.ch     # 数组操作示例
│   ├── bigint_demo.ch    # 高精度整数和大数组示例
│   ├── calculator.ch     # 计算器示例
│   ├── conditions.ch     # 条件语句示例
│   ├── function_overload.ch # 函数重载示例
│   ├── logic_operators.ch # 逻辑运算符示例
│   ├── math_demo.ch      # 数学库示例
│   ├── math_calculator.ch # 数学计算器示例
│   ├── string_basic.ch   # 字符串基础操作示例
│   ├── string_find_replace.ch # 字符串查找替换示例
│   ├── file_basic.ch     # 文件基础操作示例
│   ├── file_demo.ch      # 文件操作示例
│   ├── file_redirect.ch  # 文件重定向示例
│   ├── struct_demo.ch    # 结构体示例
│   ├── struct_array_test.ch # 结构体数组测试
│   ├── simple_struct_array.ch # 简单结构体数组示例
│   ├── minimal_struct_array.ch # 最小结构体数组示例
│   ├── scope_test.ch     # 作用域测试
│   ├── simple_test.ch    # 简单测试
│   ├── minimal_test.ch   # 最小测试
│   ├── simple_type_test.ch # 简单类型测试
│   ├── type_conversion.ch # 类型转换示例
│   └── unformatted_test.ch # 未格式化测试
└── ch_Lib/               # 标准库目录
    ├── math.ch           # 数学库
    ├── string.ch         # 字符串库
    ├── file.ch           # 文件库
    ├── readme.math.ch.md # 数学库文档
    ├── readme.string.ch.md # 字符串库文档
    └── readme.file.ch.md # 文件库文档
```

## 编译方法

### Windows平台编译

```bash
# 使用 g++ 编译
g++ -std=c++17 -I. main.cpp core/*.cpp -o chplus.exe
```

### Android JNI 编译

```bash
cd jni
ndk-build
```

**编译配置说明：**

- 目标平台: Android 21+ (arm64-v8a)
- C++ 标准: C++17
- STL 库: c++_static
- 日志支持: Android Logcat 集成
- 安全特性: 代码混淆和优化

**构建文件说明：**

- Android.mk: Android 构建脚本，定义模块配置和源文件
  - 模块名称: chplus
  - 源文件: main.cpp, lexer.cpp, parser.cpp, interpreter.cpp, CodeFormatter.cpp, CHFormatter.cpp
  - 包含路径: ../core
  - 链接库: -llog
- Application.mk: 应用配置，指定目标平台和编译选项

## 使用方法

### 基本使用

```bash
# 直接执行.ch文件
chplus example.ch
```

### 代码格式化

```bash
# 自动格式化并覆盖原文件
chplus -a example.ch

# 不自动格式化
chplus -n example.ch

# 启用调试模式
chplus -d example.ch
```

### 文件内存存储

```bash
# 使用文件内存存储（执行后自动删除memory.txt）
chplus -t example.ch

# 使用文件内存存储并保留文件
chplus -t reserve example.ch

# 使用纯内存存储（不生成txt文件，支持大数组）
chplus -t memory example.ch
```

## 语法说明

### 变量定义

```ch
// 带类型的变量定义
定义(整型) a = 10;
定义(字符串) b = "测试内容";
定义(小数) pi = 3.14;
定义(布尔型) isActive = 真;
定义(字符型) ch = 'A';

// 空定义（自动推断类型）
定义 a = 1233;           // 自动推断为整型
定义 b = 3.14;           // 自动推断为小数
定义 c = "Hello";        // 自动推断为字符串
定义 d = 真;             // 自动推断为布尔型
定义 e = 'A';            // 自动推断为字符型

// 多变量定义（一次性定义多个变量）
定义(整型) a = 1, b = 2, c = 3;
定义(字符串) name = "张三", age = "25", city = "北京";

// 空定义支持表达式类型推断
定义 f = a + 10;         // 推断为整型（整型 + 整型）
定义 g = b * 2.5;        // 推断为小数（小数 * 小数）
定义 h = a > 1000;       // 推断为布尔型（比较运算）
定义 i = !d;             // 推断为布尔型（逻辑非）
定义 j = a + b;          // 推断为小数（整型 + 小数）

// 数组定义
定义(整型) arr[10];
定义(整型) matrix[3][4];

// 复合赋值运算符
定义(整型) a = 10;
a += 5;        // a = a + 5，结果为15
a -= 3;        // a = a - 3，结果为12
a *= 2;        // a = a * 2，结果为24
a /= 4;        // a = a / 4，结果为6
a %= 4;        // a = a % 4，结果为2
a ^= 2;        // a = a ^ 2，结果为4（2的2次方）

// 自增自减运算符（前缀）
定义(整型) x = 5;
++x;           // 先增加1，x变为6，返回6
--x;           // 先减少1，x变为5，返回5

// 自增自减运算符（后置）
定义(整型) y = 5;
y++;           // 返回5，然后y变为6
y--;           // 返回6，然后y变为5

// 自增自减用于表达式
定义(整型) result = ++x;  // x增加1，返回新值
定义(整型) old = y++;     // 返回原值，y增加1
```

**空定义规则：**
- 空定义语法：`定义 变量名 = 值;`
- 必须进行赋值，不能省略初始值
- 根据赋值表达式自动推断变量类型
- 支持字面量、表达式、函数调用等多种初始化方式
- 算术运算符（+、-、*、/、%、^）：如果有一个操作数是小数，结果就是小数
- 比较运算符（==、!=、<、<=、>、>=）：结果总是布尔型
- 逻辑运算符（&&、||、!）：结果总是布尔型
- 多变量定义语法：`定义(类型) 变量1=值1, 变量2=值2, 变量3=值3;`

### 函数定义

```ch
定义(空类型) 主函数() {
    控制台输出("Hello World");
}

定义(整型) 求和(定义(整型) x, 定义(整型) y) {
    返回 x + y;
}
```

### 流程控制

```ch
如果 (条件) {
    // 条件为真时执行
} 否则如果 (其他条件) {
    // 第一个条件为假，其他条件为真时执行
} 否则 {
    // 所有条件为假时执行
}

对于 (定义(整型) i = 0; i < 10; i++) {
    // 循环体
}

当 (条件) {
    // 循环体
}
```

### 控制台输入输出

```ch
// 单个变量输出
控制台输出("Hello World");

// 多个变量输出（一次性输出多个值）
控制台输出("a=", a, " b=", b, " c=", c);

// 单个变量输入
控制台输入(变量);

// 多个变量输入（一次性读取多个输入值）
控制台输入(x, y, z);

文件写入("file.txt", "内容");
文件读取("file.txt", 变量);
文件追加("file.txt", "追加内容");
```

### 结构体

```ch
定义(结构体) Point {
    整型 x;
    整型 y;
};

定义(Point) p;
p.x = 10;
p.y = 20;
```

### 模块化编程

```ch
导入("ch_Lib/math.ch");
导入("ch_Lib/string.ch");
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    定义(小数) result = sin(30);
    定义(整型) len = 长度("Hello");
    写入文件("output.txt", "内容");
}
```

### 系统命令行

```ch
系统命令行("echo Hello");
系统命令行("dir");
```

### 文件内存存储

文件内存存储功能允许将程序中的变量持久化到文件中（默认为memory.txt），实现数据的跨程序共享和持久化。

#### 基本使用

```ch
// 使用文件内存存储执行程序
// 命令行: chplus -t example.ch
// 或保留内存文件: chplus -t reserve example.ch

定义(整型) a = 100;
定义(字符串) name = "张三";
定义(小数) pi = 3.14159;
```

#### 功能特性

- **自动持久化**：启用文件内存存储后，所有变量自动保存到memory.txt文件
- **跨程序共享**：多个程序可以共享同一个memory.txt文件，实现数据传递
- **类型保持**：变量类型信息与值一同保存，确保数据完整性
- **自动清理**：默认情况下，程序执行结束后自动删除memory.txt文件
- **保留选项**：使用`-t reserve`参数可保留memory.txt文件供后续使用

#### 使用限制

文件内存存储功能存在以下技术限制：

- **变量个数限制**：理论上无硬性上限，实际受限于文件大小和系统内存
- **整型范围限制**：-2147483648 到 2147483647（32位有符号整数）
- **小数范围限制**：±1.7976931348623157E+308（IEEE 754双精度浮点数）
- **字符串长度限制**：单行建议不超过10000字符，受文件系统和内存限制
- **运算精度限制**：浮点数运算存在精度损失，大数运算可能溢出

#### 内存文件格式

memory.txt文件采用以下格式存储变量：

```
类型:变量名:值
```

示例：
```
整型:a:100
字符串:name:张三
小数:pi:3.14159
```

#### 使用场景

1. **数据持久化**：保存程序运行状态，下次运行时恢复
2. **程序间通信**：多个程序共享数据
3. **调试分析**：保留内存文件用于调试
4. **数据导出**：将程序数据导出为文本格式

### 纯内存存储

纯内存存储功能使用C++内存直接管理变量，不生成任何文件，性能更高且支持大数组。

#### 基本使用

```ch
// 使用纯内存存储执行程序
// 命令行: chplus -t memory example.ch

定义(整型) a[100000];
定义(整型) i;
对于 (i = 0; i < 100000; i++) {
    a[i] = i * 2;
}
```

#### 功能特性

- **高性能**：所有变量存储在C++内存中，访问速度极快
- **无文件IO**：不生成任何txt文件，减少磁盘IO开销
- **支持大数组**：不受1000个元素限制，支持超大数组
- **自动清理**：程序结束后自动释放所有内存，无需手动清理

#### 使用场景

1. **大数组处理**：需要处理超大数组时使用
2. **高性能计算**：需要最高性能时使用
3. **临时计算**：不需要持久化数据时使用
4. **内存密集型任务**：需要大量内存操作时使用

### 高精度整数计算

解释器内置BigInt高精度整数计算功能，支持任意长度的整数运算，不受传统整数类型限制。

#### 基本使用

```ch
// 超大整数运算
定义(整型) a = 12345678901234567890;
定义(整型) b = 98765432109876543210;

定义(整型) sum = a + b;
定义(整型) diff = a - b;
定义(整型) prod = a * b;
定义(整型) quot = a / b;
定义(整型) mod = a % b;
定义(整型) power = a ^ 2;

控制台输出("a + b = " + sum);      // 111111111011111111100
控制台输出("a - b = " + diff);      // -86419753208641975320
控制台输出("a * b = " + prod);      // 1219326311370217952237463801111263526900
```

#### 支持的运算

- **基本运算**：`+`（加法）、`-`（减法）、`*`（乘法）、`/`（除法）、`%`（取模）
- **乘方运算**：`^`（乘方）
- **比较运算**：`==`、`!=`、`<`、`<=`、`>`、`>=`
- **复合赋值**：`+=`、`-=`、`*=`、`/=`、`%=`、`^=`
- **自增自减**：`++`、`--`（前缀和后置）
- **一元运算**：`-`（负号）

#### 功能特性

- **任意长度**：支持任意长度的整数运算，仅受系统内存限制
- **精确计算**：所有运算都是精确的整数运算，无精度损失
- **正负支持**：完全支持正数和负数运算
- **除零检查**：自动检测除零错误并给出友好提示
- **类型兼容**：与现有的整型类型完全兼容，无需修改代码

#### 使用场景

1. **大数计算**：需要处理超大整数时使用
2. **精确计算**：需要精确整数运算时使用
3. **密码学**：需要大数模运算时使用
4. **科学计算**：需要高精度整数运算时使用

#### 技术实现

- 使用自定义BigInt类实现大整数运算
- 基于vector存储数字，支持动态扩容
- 实现了完整的运算符重载
- 所有算术运算都使用BigInt进行计算

## 标准库

### 数学库 (math.ch)

- 三角函数：sin, cos, tan, asin, acos, atan
- 双曲函数：sinh, cosh, tanh
- 指数对数：exp, log, log10, sqrt, cbrt
- 取整函数：ceil, floor, round, trunc
- 绝对值：abs, fabs
- 其他函数：fmod, gcd, lcm
- 数学常量：PI, E, SQRT2

### 字符串库 (string.ch)

- 基础操作：长度、子串、查找、替换
- 转换功能：转大写、转小写、去空白
- 类型转换：整数转字符串、小数转字符串、布尔值转字符串
- 字符操作：获取字符、翻转、计数
- 高级功能：填充、分割、连接

### 文件库 (file.ch)

- 文件操作：文件写入、文件读取、文件追加、文件存在
- 文件重定向：重定向标准输出、恢复标准输出
- 文件系统：获取大小、路径操作
- 目录操作：创建、删除、重命名
- 文本处理：逐行读取、分割、合并

## 命令行选项

- `-a` : 自动格式化并覆盖原文件
- `-d` : 启用调试模式，显示详细执行信息
- `-t` : 使用文件内存存储（memory.txt），执行后自动删除
- `-t reserve` : 使用文件内存存储（memory.txt），执行后保留文件
- `-t memory` : 使用纯内存存储，不生成txt文件，支持大数组和高精度计算
- `-n, --no-format` : 不自动格式化代码
- `-h, --help` : 显示帮助信息

## 许可证

原项目源库：[https://github.com/abcdefgjh-li/chplus]
