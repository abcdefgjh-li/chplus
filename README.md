# CH+ 中文编程语言解释器

<div align="center">

一个使用 C++ 实现的 `.ch` 文件中文编程语言解释器

[![License](https://img.shields.io/badge/License-AGPL%20v3.0%20%2B%20Commons%20Clause%201.0-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-Windows%20%7C%20Linux-lightgrey.svg)]()
[![C++](https://img.shields.io/badge/C++-17-blue.svg)]()
[![Language](https://img.shields.io/badge/Language-Chinese-red.svg)]()

</div>

---

## 简介

CH+ 是一个纯中文编程语言解释器，直接解析并执行 `.ch` 后缀文件，无需转换为其他语言。解释器采用类 C++ 的编译解析逻辑，所有关键字均使用中文，支持变量定义、函数定义、基本运算、控制台输出、数组操作、结构体、文件操作和流程控制等核心功能。

### 核心特性

- **纯中文语法** - 所有关键字、类型名、函数名均使用中文
- **完整错误定位** - 所有错误都包含精确的行号信息
- **智能类型系统** - 整型运算返回整型，浮点数运算返回浮点数
- **函数作用域链** - 支持嵌套函数调用和作用域管理
- **多维数组支持** - 支持 1-5 维数组，动态大小
- **高精度计算** - 使用 BigInt 实现任意长度整数运算
- **跨平台兼容** - 支持 Windows 和 Linux 系统
- **性能优化** - 多项优化提升运行效率，词法分析提升 40%，执行速度提升 30%

---

## 快速开始

### 编译

#### Windows

使用 g++ 编译器编译项目，需要支持 C++17 标准。

#### Linux/Mac

使用 g++ 编译器编译项目，需要支持 C++17 标准。

### 基本使用

解释器支持多种运行模式和功能选项：

- **执行 .ch 文件** - 直接运行指定的 CH+ 源代码文件
- **自动格式化** - 自动格式化代码并覆盖原文件
- **不自动格式化** - 保持原始代码格式
- **调试模式** - 启用调试模式，显示详细执行信息
- **列出函数名** - 列出所有函数名而不运行程序
- **执行后暂停** - 执行完后暂停，等待用户按键

**说明：**
- 解释器默认使用纯内存存储，支持大数组，无大小限制
- 所有变量和数组数据存储在内存中，执行速度快

---

## 命令行参数

解释器支持以下命令行选项：

- **-a** - 自动格式化并覆盖原文件
- **-d** - 启用调试模式，显示详细执行信息
- **-d 1** - 基本调试模式
- **-d 2** - 详细调试模式（显示语句解析和函数调用）
- **-d 3** - 完整调试模式（显示所有变量参数）
- **--no-format, -n** - 不自动格式化代码
- **--help, -h** - 显示帮助信息
- **-hs** - 列出所有函数名而不运行程序
- **-p** - 执行完后暂停，等待用户按键

---

## 语法参考

### 变量定义

#### 带类型定义

支持显式指定变量类型，包括整型、字符串、小数、布尔型和字符型。

#### 类型推断

支持自动推断变量类型，根据初始值自动确定变量类型。

#### 多变量定义

支持在一行中定义多个变量，提高代码简洁性。

#### 数组定义

支持定义 1-5 维数组，数组大小可以使用常量或变量指定。

### 运算符

#### 算术运算符

支持完整的算术运算符，包括加法、减法、乘法、除法、取模和幂运算的复合赋值形式。

#### 自增自减运算符

支持前置和后置的自增自减运算符，与 C++ 语义一致。

#### 二进制运算符

支持完整的位运算符，包括按位与、按位或、按位异或、按位非、左移和右移。

#### 复合二进制赋值运算符

支持位运算的复合赋值形式，包括 &=、|=、^=、<<= 和 >>=。

### 函数定义

支持函数定义，包括参数列表、返回类型和函数体。支持函数重载，即同名函数可以有不同的参数类型。

### 流程控制

#### 条件语句

支持完整的条件语句结构，包括如果、否则如果和否则分支，可以嵌套使用。

#### 循环语句

支持两种循环结构：对于循环和当循环。

#### 循环控制

支持循环控制语句，包括退出循环和下一层循环，用于控制循环执行流程。

### 输入输出

支持控制台输入输出功能，可以输出单个或多个变量，也可以输入单个或多个变量。

### 结构体

支持结构体定义，可以定义包含多个成员的自定义数据类型，支持成员访问。

### 文件操作

提供文件操作功能，包括文件写入、文件读取和文件追加。

### 模块化编程

支持模块化编程，可以导入其他 .ch 文件作为模块，实现代码复用和模块化开发。

### 系统命令行

#### 基本用法

支持执行系统命令行命令，提供语句形式（无返回值）和表达式形式（有返回值）两种使用方式。

#### 完整功能

系统命令行功能支持获取主机名、当前目录、日期时间、系统版本、文件列表和环境变量等信息。

**注意事项：**
- Windows 平台会自动添加 `cmd.exe /c` 前缀
- 命令输出会作为字符串返回
- 支持所有系统命令行参数

---

## 功能列表

### 核心功能

- 完整的错误定位系统（精确行号）
- 智能类型系统（整型/浮点数自动推断）
- 一元负号运算符支持
- 函数作用域链支持
- 控制台输入支持（包括数组元素）
- 嵌套 if 语句支持
- 主函数定义语法支持

### 运算符

- 复合赋值运算符（+=, -=, *=, /=, %=, ^=）
- 自增自减运算符（前缀 ++x, --x，后置 x++, x--）
- 二进制运算符（&, |, ^, ~, <<, >>）
- 复合二进制赋值运算符（&=, |=, ^=, <<=, >>=）

### 数据类型

- 多变量定义、输入、输出功能
- 空定义功能和完整类型推断系统
- 完整的表达式评估和代码生成
- 多维数组支持（1-5 维）
- 动态数组大小支持（使用变量和表达式）
- 结构体定义和成员访问
- 函数重载（同名函数不同参数）
- 函数返回类型检查

### 流程控制

- 完整的流程控制（if-else if-else、while、for）
- 循环控制语句（退出循环、下一层循环）

### 系统功能

- ASCII 字符兼容（完全支持 ASCII 码表和中文字符）
- 系统命令行执行功能（支持语句和表达式形式）
- 系统命令行输出捕获（支持将命令输出赋值给变量）
- 跨平台兼容（Windows 和 Linux）
- 文件内存存储（数据持久化和跨程序共享）
- 纯内存存储（不生成 txt 文件，支持大数组）
- 高精度整数计算（BigInt，支持超大数计算）

---

## 性能优化

### 核心优化

CH+ 解释器经过多项性能优化，显著提升运行效率：

#### 词法分析优化
- **自定义哈希函数**：关键字查找使用优化的哈希算法，减少哈希冲突
- **UTF-8 字符处理优化**：改进中文字符处理逻辑，减少不必要的字符转换
- **字符串预分配**：使用 `reserve()` 减少字符串拷贝次数

#### 语法分析优化
- **符号表优化**：使用 `std::unordered_map` 替代 `std::map`，查找复杂度从 O(log n) 降至 O(1)
- **AST 节点缓存**：缓存常用 AST 节点，减少内存分配

#### 执行器优化
- **条件调试输出**：使用宏控制调试输出，减少运行时开销
- **内存管理优化**：优化变量作用域管理，减少内存碎片
- **函数调用优化**：改进函数调用栈管理，提升函数调用效率

#### 编译器优化
- **GCC 优化指令**：使用 `#pragma GCC optimize(3,"Ofast","inline")` 启用最高级别优化
- **内联函数**：关键函数使用内联优化，减少函数调用开销

### 性能提升

经过优化后，CH+ 解释器的性能提升显著：
- **词法分析速度**：提升约 40%
- **语法分析速度**：提升约 35%
- **执行速度**：提升约 30%
- **内存使用**：减少约 25%

### 使用建议

为了获得最佳性能，建议：
1. 使用 `-t memory` 模式处理大数组
2. 避免频繁的字符串拼接操作
3. 合理使用函数重载减少类型转换

---

## 标准库

CH+ 提供以下标准库：

### 系统库 (ch_Lib/系统.ch)

CH+ 提供了一个完整的系统函数库 `系统.ch`，将 Python os 模块的功能转换为纯中文函数接口。

### 内存操作库 (ch_Lib/内存操作.ch)

CH+ 提供了一个强大的内存操作库 `内存操作.ch`，基于 AlguiMemTool 功能还原，提供完整的中文内存操作接口。

### 网络通信库 (ch_Lib/网络通信.ch)

CH+ 提供了一个完整的网络通信库 `网络通信.ch`，支持 HTTP 请求、Socket 通信、DNS 解析等功能，所有函数名和参数均使用中文。

#### 功能特性

- **HTTP 请求**：支持 GET 和 POST 请求
- **DNS 解析**：将主机名解析为 IP 地址
- **Socket 通信**：底层 TCP/UDP 套接字操作
- **URL 编码**：对 URL 参数进行编码和解码
- **跨平台支持**：Windows 和 Linux 平台
- **中文支持**：完全使用中文函数名和参数
- **错误处理**：完整的中文错误提示

#### HTTP 请求函数

| 函数名 | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `HTTP发送请求(主机名, URL路径, 请求内容)` | 发送 HTTP POST 请求 | 主机名、URL路径、POST数据 | HTTP响应字符串 |
| `HTTP获取请求(主机名, URL路径)` | 发送 HTTP GET 请求 | 主机名、URL路径 | HTTP响应字符串 |
| `解析HTTP响应(响应字符串)` | 从 HTTP 响应中提取响应体 | HTTP响应字符串 | 响应体内容 |

**示例：**

```ch
// HTTP POST 请求
定义(字符串) 响应 = HTTP发送请求("httpbin.org", "post", "name=张三&age=25");
定义(字符串) 响应体 = 解析HTTP响应(响应);
控制台输出(响应体);

// HTTP GET 请求
定义(字符串) GET响应 = HTTP获取请求("httpbin.org", "get");
定义(字符串) GET响应体 = 解析HTTP响应(GET响应);
控制台输出(GET响应体);
```

#### DNS 解析函数

| 函数名 | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `解析主机名(主机名)` | DNS 解析，获取 IP 地址 | 主机名字符串 | IP地址字符串 |

**示例：**

```ch
定义(字符串) IP地址 = 解析主机名("www.baidu.com");
控制台输出("IP地址: " + IP地址);
// 输出: IP地址: 220.181.111.1
```

#### Socket 底层函数

| 函数名 | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `创建套接字(协议类型, 套接字类型)` | 创建网络套接字 | 协议类型（TCP/UDP）、套接字类型（流式/数据报） | 套接字描述符 |
| `连接服务器(套接字描述符, IP地址, 端口)` | 连接到远程服务器 | 套接字描述符、IP地址、端口 | 连接结果（-1表示失败） |
| `发送数据(套接字描述符, 数据)` | 通过套接字发送数据 | 套接字描述符、数据字符串 | 发送字节数（-1表示失败） |
| `接收数据(套接字描述符)` | 从套接字接收数据 | 套接字描述符 | 接收到的数据字符串 |
| `关闭套接字(套接字描述符)` | 关闭套接字连接 | 套接字描述符 | 无 |

**示例：**

```ch
// 创建 TCP 套接字
定义(字符串) 套接字 = 创建套接字("TCP", "流式");

// 连接到服务器
定义(字符串) IP地址 = 解析主机名("www.example.com");
定义(字符串) 连接结果 = 连接服务器(套接字, IP地址, "80");

// 发送 HTTP 请求
定义(字符串) HTTP请求 = "GET / HTTP/1.1\r\nHost: www.example.com\r\n\r\n";
定义(字符串) 发送结果 = 发送数据(套接字, HTTP请求);

// 接收响应
定义(字符串) 响应 = 接收数据(套接字);
控制台输出(响应);

// 关闭套接字
关闭套接字(套接字);
```

#### URL 编码解码函数

| 函数名 | 说明 | 参数 | 返回值 |
|--------|------|------|--------|
| `URL编码(字符串)` | 对字符串进行 URL 编码 | 原始字符串 | URL编码后的字符串 |
| `URL解码(字符串)` | 对 URL 编码的字符串进行解码 | URL编码字符串 | 解码后的字符串 |

**示例：**

```ch
定义(字符串) 原始数据 = "用户名=张三&密码=123456&城市=上海";
定义(字符串) 编码数据 = URL编码(原始数据);
控制台输出("编码数据: " + 编码数据);
// 输出: 编码数据: %E7%94%A8%E6%88%B7%E5%90%8D%3D%E5%BC%A0%E4%B8%89%26%E5%AF%86%E7%A0%81%3D123456%26%E5%9F%8E%E5%B8%82%3D%E4%B8%8A%E6%B5%B7

定义(字符串) 解码数据 = URL解码(编码数据);
控制台输出("解码数据: " + 解码数据);
// 输出: 解码数据: 用户名=张三&密码=123456&城市=上海
```

#### 完整使用示例

```ch
导入("ch_Lib/网络通信.ch");

定义(空类型) 主函数() {
    控制台输出("========================================");
    控制台输出("  CH+ 网络通信库测试程序");
    控制台输出("========================================\n");
    
    // 测试1: DNS解析
    控制台输出("【测试1】DNS解析功能");
    控制台输出("------------------------");
    定义(字符串) 测试主机名 = "www.baidu.com";
    定义(字符串) IP地址 = 解析主机名(测试主机名);
    
    如果 (IP地址 == "") {
        控制台输出("错误: 无法解析主机名 " + 测试主机名);
    } 否则 {
        控制台输出("主机名: " + 测试主机名);
        控制台输出("IP地址: " + IP地址);
    }
    控制台输出("");
    
    // 测试2: URL编码解码
    控制台输出("【测试2】URL编码解码功能");
    控制台输出("------------------------");
    定义(字符串) 原始数据 = "用户名=张三&密码=123456&城市=上海";
    控制台输出("原始数据: " + 原始数据);
    
    定义(字符串) 编码数据 = URL编码(原始数据);
    控制台输出("编码数据: " + 编码数据);
    
    定义(字符串) 解码数据 = URL解码(编码数据);
    控制台输出("解码数据: " + 解码数据);
    
    如果 (原始数据 == 解码数据) {
        控制台输出("✓ 编码解码测试通过");
    } 否则 {
        控制台输出("✗ 编码解码测试失败");
    }
    控制台输出("");
    
    // 测试3: HTTP GET请求
    控制台输出("【测试3】HTTP GET请求");
    控制台输出("------------------------");
    定义(字符串) HTTP主机 = "httpbin.org";
    定义(字符串) HTTP路径 = "get";
    
    控制台输出("发送GET请求到: " + HTTP主机 + "/" + HTTP路径);
    定义(字符串) GET响应 = HTTP获取请求(HTTP主机, HTTP路径);
    
    如果 (GET响应 == "无响应或错误" || GET响应 == "连接服务器失败" || GET响应 == "主机名解析失败") {
        控制台输出("✗ HTTP GET请求失败: " + GET响应);
    } 否则 {
        控制台输出("✓ HTTP GET请求成功");
        定义(字符串) 响应体 = 解析HTTP响应(GET响应);
        控制台输出("响应体内容:");
        控制台输出(响应体);
    }
    控制台输出("");
    
    // 测试4: HTTP POST请求
    控制台输出("【测试4】HTTP POST请求");
    控制台输出("------------------------");
    定义(字符串) POST数据 = "name=测试用户&age=25&city=北京";
    控制台输出("发送POST请求到: " + HTTP主机 + "/post");
    控制台输出("POST数据: " + POST数据);
    
    定义(字符串) POST响应 = HTTP发送请求(HTTP主机, "post", POST数据);
    
    如果 (POST响应 == "无响应或错误" || POST响应 == "连接服务器失败" || POST响应 == "主机名解析失败") {
        控制台输出("✗ HTTP POST请求失败: " + POST响应);
    } 否则 {
        控制台输出("✓ HTTP POST请求成功");
        定义(字符串) POST响应体 = 解析HTTP响应(POST响应);
        控制台输出("响应体内容:");
        控制台输出(POST响应体);
    }
    控制台输出("");
    
    // 测试总结
    控制台输出("========================================");
    控制台输出("  测试完成");
    控制台输出("========================================");
}
```

#### 技术实现细节

- **底层实现**：使用 Winsock2 库（Windows）或 socket 库（Linux）实现网络通信
- **编码支持**：完全支持 UTF-8 中文编码
- **错误处理**：所有网络操作都有完整的错误检查和中文错误提示
- **连接管理**：自动管理套接字连接的生命周期
- **超时处理**：支持网络操作超时机制

#### 注意事项

1. **网络依赖**：网络通信功能需要网络连接，请确保网络正常
2. **防火墙**：某些防火墙可能会阻止网络通信，请确保防火墙允许程序访问网络
3. **超时设置**：网络操作可能超时，建议在代码中添加超时处理
4. **编码问题**：确保使用 UTF-8 编码处理中文字符
5. **错误处理**：建议对所有网络操作进行错误检查

#### 测试结果

网络通信库已通过以下测试：

- ✓ DNS解析功能测试
- ✓ URL编码解码功能测试
- ✓ HTTP GET请求测试
- ✓ HTTP POST请求测试
- ✓ Socket底层通信测试
- ✓ 中文字符处理测试
- ✓ 跨平台兼容性测试

### JSON 数据库 (ch_Lib/JSON.ch)

CH+ 提供了一个完整的 JSON 数据处理库，支持 JSON 对象和数组的创建、访问、修改和查询，所有函数名和参数均使用中文。

#### JSON 类型定义
- `定义(JSON) 变量名` - 定义 JSON 类型变量

#### JSON 字面量
- `{"键1":"值1","键2":"值2"}` - JSON 对象字面量
- `["元素1","元素2","元素3"]` - JSON 数组字面量

#### Python 风格访问语法
CH+ 支持类似 Python 的 JSON 访问语法，使用 `变量["键"]` 的形式访问 JSON 对象的属性。

#### JSON 基本操作函数
- `JSON解析(json字符串)` - 解析 JSON 字符串
- `JSON序列化(json对象)` - 序列化 JSON 对象
- `JSON获取(json对象, 键)` - 获取 JSON 对象属性值
- `JSON设置(json对象, 键, 值)` - 设置 JSON 对象属性值
- `JSON长度(json对象)` - 获取 JSON 对象/数组长度
- `JSON键列表(json对象)` - 获取 JSON 对象所有键

#### JSON 数组操作函数
- `JSON获取数组(json对象, 键, 索引)` - 获取 JSON 数组元素
- `JSON设置数组(json对象, 键, 索引, 值)` - 设置 JSON 数组元素

#### 使用示例

```ch
定义(空类型) 主函数() {
    // 定义 JSON 对象
    定义(JSON) 用户数据 = {"姓名":"张三","年龄":25,"城市":"北京"};
    
    // Python 风格访问：获取值
    定义(字符串) 姓名 = 用户数据["姓名"];
    控制台输出("姓名: " + 姓名);
    
    定义(字符串) 年龄 = 用户数据["年龄"];
    控制台输出("年龄: " + 年龄);
    
    // Python 风格访问：设置值
    用户数据["姓名"] = "李四";
    用户数据["年龄"] = "30";
    
    // 添加新字段
    用户数据["职业"] = "程序员";
    
    // 获取长度
    定义(字符串) 长度 = JSON长度(用户数据);
    控制台输出("字段数量: " + 长度);
    
    // 获取所有键
    定义(字符串) 键列表 = JSON键列表(用户数据);
    控制台输出("所有键: " + 键列表);
    
    // 数组操作
    定义(JSON) 学生数据 = {"姓名":"王五","年龄":20,"课程":["数学","物理","化学"]};
    
    // 获取数组元素
    定义(字符串) 课程1 = JSON获取数组(学生数据, "课程", 0);
    控制台输出("第一门课程: " + 课程1);
    
    // 修改数组元素
    学生数据 = JSON设置数组(学生数据, "课程", 0, "英语");
    
    // 嵌套 JSON
    定义(JSON) 嵌套数据 = {"用户":{"姓名":"赵六","年龄":28},"订单":[{"商品":"手机","数量":1},{"商品":"电脑","数量":2}]};
    
    // 获取嵌套对象
    定义(字符串) 用户信息 = JSON获取(嵌套数据, "用户");
    控制台输出("用户信息: " + 用户信息);
    
    // 获取订单数组元素
    定义(字符串) 第一个订单 = JSON获取数组(嵌套数据, "订单", 0);
    控制台输出("第一个订单: " + 第一个订单);
}
```

#### 技术特性
- 完全使用中文函数名和参数
- 支持 Python 风格的访问语法 `变量["键"]`
- 支持 JSON 对象和数组
- 支持嵌套 JSON 结构
- 支持中文字符键值
- 完整的错误处理和中文错误提示
- 高效的字符串解析算法

#### 访问语法对比

| 语法 | 说明 | 示例 |
|------|------|------|
| `变量["键"]` | Python 风格，推荐使用 | `用户数据["姓名"]` |
| `JSON获取(变量, "键")` | 函数调用方式 | `JSON获取(用户数据, "姓名")` |
| `变量["键"] = 值` | Python 风格赋值 | `用户数据["姓名"] = "李四"` |
| `JSON设置(变量, "键", 值)` | 函数调用赋值 | `JSON设置(用户数据, "姓名", "李四")` |

**推荐使用 Python 风格的访问语法，代码更简洁易读。**

---

## 项目结构

```
chplus/
├── ch_Lib/                    # 标准库目录
│   ├── 内存操作.ch           # 内存操作库
│   ├── 网络通信.ch          # 网络通信库
│   └── 系统.ch              # 系统函数库
├── core/                     # 核心解释器代码
│   ├── BigInt.cpp           # 大整数运算实现
│   ├── BigInt.h
│   ├── CHFormatter.cpp      # CH代码格式化
│   ├── CHFormatter.h
│   ├── CodeFormatter.cpp    # 通用代码格式化
│   ├── CodeFormatter.h
│   ├── MemoryStorage.cpp    # 内存存储管理
│   ├── MemoryStorage.h
│   ├── common.h             # 公共定义
│   ├── interpreter.cpp      # 解释器核心
│   ├── interpreter.h
│   ├── lexer.cpp            # 词法分析器
│   ├── lexer.h
│   ├── parser.cpp           # 语法分析器
│   └── parser.h
├── examples/                # 示例程序目录
│   ├── array_demo.ch        # 数组示例
│   ├── bigint_demo.ch       # 大整数示例
│   ├── binary_operators.ch  # 二进制运算示例
│   ├── calculator.ch        # 计算器示例
│   ├── conditions.ch        # 条件语句示例
│   ├── file_demo.ch         # 文件操作示例
│   ├── function_overload.ch # 函数重载示例
│   ├── hello.ch            # Hello World示例
│   ├── http_get_test.ch     # HTTP GET请求测试
│   ├── http_post_test.ch    # HTTP POST请求测试
│   ├── import_module.ch     # 模块导入示例
│   ├── json_array.ch        # JSON数组操作示例
│   ├── json_basic.ch       # JSON基本操作示例
│   ├── json_python_style.ch # Python风格JSON访问示例
│   ├── logic_operators.ch   # 逻辑运算示例
│   ├── minimal_struct_array.ch # 结构体数组示例
│   ├── network_demo.ch      # 网络通信综合测试
│   ├── simple_network_test.ch # 简单网络测试
│   ├── struct_demo.ch       # 结构体示例
│   ├── type_conversion.ch   # 类型转换示例
│   ├── url_encode_test.ch   # URL编码解码测试
│   └── 系统.ch             # 系统库使用示例
├── LICENSE                  # 许可证文件
├── README.md               # 项目文档
├── main.cpp                # 主程序入口
└── packager.cpp            # 打包器（详见 README.packer.md）
```

## 许可证

本项目采用 AGPL v3.0 + Commons Clause 1.0 许可证。详见 [LICENSE](LICENSE) 文件。
