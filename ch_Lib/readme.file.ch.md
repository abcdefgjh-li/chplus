# ch_Lib 文件库 (file.ch)

## 概述

`file.ch` 是一个为 chplus 中文解释器开发的完整文件库，包含了 C++ 文件操作的所有主要功能，特别实现了类似 C++ `freopen` 的文件重定向功能。这个库为 chplus 语言提供了强大的文件处理能力。

## 库信息

- **版本**: 1.0
- **作者**: chplus解释器
- **包含功能**: C++文件操作和freopen功能的完整实现
- **语言**: 中文(.ch)

## 导入方式

```ch
导入("ch_Lib/file.ch");
```

## 功能分类

### 1. 文件重定向功能（类似freopen）

#### 标准流重定向

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 自由打开输出文件 | `自由打开输出文件(filename, mode)` | 类似freopen的通用文件重定向 | `自由打开输出文件("output.txt", "写")` |
| 重定向标准输出 | `重定向标准输出(filename)` | 将stdout重定向到文件 | `重定向标准输出("log.txt")` |
| 重定向标准输出追加 | `重定向标准输出追加(filename)` | 将stdout重定向到文件（追加模式） | `重定向标准输出追加("log.txt")` |
| 重定向标准输入 | `重定向标准输入(filename)` | 将stdin重定向到文件 | `重定向标准输入("input.txt")` |
| 恢复标准输出 | `恢复标准输出()` | 恢复stdout到控制台 | `恢复标准输出()` |
| 恢复标准输入 | `恢复标准输入()` | 恢复stdin到键盘 | `恢复标准输入()` |

### 2. 文件读写操作

#### 基本文件操作

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 读取文件 | `读取文件(filename)` | 读取整个文件内容 | `读取文件("data.txt")` |
| 写入文件 | `写入文件(filename, content)` | 写入内容到文件（覆盖模式） | `写入文件("output.txt", "Hello World")` |
| 追加文件 | `追加文件(filename, content)` | 追加内容到文件 | `追加文件("log.txt", "New line")` |
| 读取文件前N行 | `读取文件前N行(filename, n)` | 读取文件的前N行 | `读取文件前N行("data.txt", 10)` |
| 读取文件第N行 | `读取文件第N行(filename, line_number)` | 读取文件的第N行 | `读取文件第N行("data.txt", 5)` |

### 3. 文件系统操作

#### 文件属性检查

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 文件存在 | `文件存在(filename)` | 检查文件是否存在 | `文件存在("config.txt")` |
| 是文件 | `是文件(path)` | 检查是否为文件 | `是文件("document.pdf")` |
| 是目录 | `是目录(path)` | 检查是否为目录 | `是目录("src")` |
| 文件大小 | `文件大小(filename)` | 获取文件大小（字节） | `文件大小("image.jpg")` |

#### 文件信息提取

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 文件扩展名 | `文件扩展名(filename)` | 获取文件扩展名 | `文件扩展名("document.txt") = ".txt"` |
| 文件名 | `文件名(filepath)` | 获取文件名（不含路径） | `文件名("/path/file.txt") = "file.txt"` |
| 文件路径 | `文件路径(filepath)` | 获取文件路径（不含文件名） | `文件路径("/path/file.txt") = "/path"` |

### 4. 文件和目录操作

#### 文件管理

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 创建目录 | `创建目录(dirname)` | 创建新目录 | `创建目录("backup")` |
| 删除文件 | `删除文件(filename)` | 删除指定文件 | `删除文件("temp.txt")` |
| 删除目录 | `删除目录(dirname)` | 删除指定目录 | `删除目录("old_folder")` |
| 重命名文件 | `重命名文件(old_name, new_name)` | 重命名文件 | `重命名文件("old.txt", "new.txt")` |

### 5. 文本文件处理

#### 高级文本操作

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 读取文件行 | `读取文件行(filename)` | 逐行读取文件到数组 | `读取文件行("log.txt")` |
| 写入多行 | `写入多行(filename, lines)` | 将数组内容写入文件 | `写入多行("output.txt", lines_array)` |
| 合并文件 | `合并文件(file1, file2, output_file)` | 合并两个文件 | `合并文件("part1.txt", "part2.txt", "full.txt")` |
| 分割文件 | `分割文件(filename, lines_per_file, prefix)` | 分割大文件为多个小文件 | `分割文件("big.txt", 1000, "chunk")` |

### 6. 路径操作

#### 路径处理

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 连接路径 | `连接路径(path1, path2)` | 连接两个路径 | `连接路径("/home", "user") = "/home/user"` |
| 获取绝对路径 | `获取绝对路径(filepath)` | 获取文件的绝对路径 | `获取绝对路径("file.txt") = "/current/path/file.txt"` |
| 标准化路径 | `标准化路径(filepath)` | 标准化文件路径格式 | `标准化路径("\\path\\\\file.txt") = "/path/file.txt"` |

### 7. 文件类型检查

#### 文件类型识别

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 是文本文件 | `是文本文件(filename)` | 检查是否为文本文件 | `是文本文件("script.py") = 真` |
| 是二进制文件 | `是二进制文件(filename)` | 检查是否为二进制文件 | `是二进制文件("image.jpg") = 真` |
| 文件类型描述 | `文件类型描述(filename)` | 获取文件类型的文字描述 | `文件类型描述("photo.jpg") = "图片文件"` |

### 8. 临时文件操作

#### 临时文件管理

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 创建临时文件 | `创建临时文件(prefix)` | 创建临时文件 | `创建临时文件("temp") = "temp_XXXXXX"` |
| 系统临时目录 | `系统临时目录()` | 获取系统临时目录 | `系统临时目录() = "/tmp"` |

### 9. 文件锁定操作

#### 文件同步控制

| 函数 | 语法 | 描述 | 示例 |
|------|------|------|------|
| 锁定文件 | `锁定文件(filename)` | 锁定文件防止其他进程访问 | `锁定文件("shared.txt")` |
| 解锁文件 | `解锁文件(filename)` | 解锁文件 | `解锁文件("shared.txt")` |

### 10. 库信息函数

#### 库元数据

| 函数 | 语法 | 描述 |
|------|------|------|
| 文件库版本 | `文件库版本()` | 返回文件库的版本信息 |
| 文件库信息 | `文件库信息()` | 返回库的功能描述 |
| 文件常量有效 | `文件常量有效()` | 验证文件常量的有效性 |
| 支持的文件模式 | `支持的文件模式()` | 返回支持的文件模式列表 |

## 使用示例

### 基本文件操作

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 文件操作基础示例 ===");
    
    // 检查文件是否存在
    如果 (文件存在("config.txt")) {
        控制台输出("配置文件存在");
    } 否则 {
        控制台输出("配置文件不存在，将创建新文件");
    }
    
    // 写入文件
    定义(字符串) content = "Hello, World!\n这是中文内容。";
    写入文件("output.txt", content);
    控制台输出("已写入内容到 output.txt");
    
    // 读取文件
    定义(字符串) file_content = 读取文件("output.txt");
    控制台输出("文件内容: " + file_content);
}
```

### 文件重定向示例（类似freopen）

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 文件重定向示例 ===");
    
    // 重定向标准输出到文件
    重定向标准输出("log.txt");
    控制台输出("这条信息将写入 log.txt 文件");
    控制台输出("而不是显示在控制台上");
    
    // 恢复标准输出到控制台
    恢复标准输出();
    控制台输出("现在输出显示在控制台上");
    
    // 追加模式重定向
    重定向标准输出追加("log.txt");
    控制台输出("这条信息追加到 log.txt");
    恢复标准输出();
}
```

### 文件系统操作示例

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 文件系统操作示例 ===");
    
    定义(字符串) filepath = "/home/user/documents/report.txt";
    
    // 获取文件信息
    控制台输出("文件路径: " + filepath);
    控制台输出("文件名: " + 文件名(filepath));
    控制台输出("文件路径: " + 文件路径(filepath));
    控制台输出("文件扩展名: " + 文件扩展名(filepath));
    
    // 检查文件类型
    如果 (是文本文件(filepath)) {
        控制台输出("这是一个文本文件");
    }
    
    控制台输出("文件类型: " + 文件类型描述(filepath));
    
    // 路径操作
    定义(字符串) full_path = 连接路径("/home/user", "documents/report.txt");
    控制台输出("完整路径: " + full_path);
    控制台输出("绝对路径: " + 获取绝对路径("report.txt"));
}
```

### 目录和文件管理示例

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 目录和文件管理示例 ===");
    
    // 创建目录
    创建目录("backup");
    控制台输出("已创建 backup 目录");
    
    // 重命名文件
    重命名文件("old_file.txt", "new_file.txt");
    控制台输出("已重命名文件");
    
    // 获取文件大小
    定义(整型) size = 文件大小("new_file.txt");
    控制台输出("文件大小: " + 整数转字符串(size) + " 字节");
    
    // 删除文件
    删除文件("temp.txt");
    控制台输出("已删除临时文件");
}
```

### 文本文件处理示例

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 文本文件处理示例 ===");
    
    // 写入多行内容
    定义(字符串) lines[] = ["第1行内容", "第2行内容", "第3行内容"];
    // 注意：chplus中的数组操作需要根据具体实现调整
    
    写入多行("multi_line.txt", lines);
    控制台输出("已写入多行到文件");
    
    // 读取特定行
    定义(字符串) first_line = 读取文件第N行("multi_line.txt", 1);
    控制台输出("第1行: " + first_line);
    
    // 读取前几行
    定义(字符串) first_lines = 读取文件前N行("multi_line.txt", 2);
    控制台输出("前2行: " + first_lines);
    
    // 文件分割
    分割文件("large_file.txt", 1000, "chunk_");
    控制台输出("已将大文件分割为多个小文件");
}
```

### 临时文件和锁定示例

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 临时文件和锁定示例 ===");
    
    // 创建临时文件
    定义(字符串) temp_file = 创建临时文件("session");
    控制台输出("临时文件: " + temp_file);
    控制台输出("临时目录: " + 系统临时目录());
    
    // 文件锁定
    锁定文件("shared_data.txt");
    控制台输出("已锁定共享文件");
    
    // 执行需要独占访问的操作
    写入文件("shared_data.txt", "处理中...");
    
    // 解锁文件
    解锁文件("shared_data.txt");
    控制台输出("已解锁共享文件");
}
```

### 高级路径处理示例

```ch
导入("ch_Lib/file.ch");

定义(空类型) 主函数() {
    控制台输出("=== 高级路径处理示例 ===");
    
    // 处理不同格式的路径
    定义(字符串) paths[] = {
        "C:\\Windows\\System32\\file.txt",
        "/usr/local/bin/script.sh",
        "./relative/path/file.txt",
        "file.txt"
    };
    
    定义(整型) i = 0;
    当 (i < 4) {
        定义(字符串) path = paths[i];
        控制台输出("原始路径: " + path);
        控制台输出("标准化路径: " + 标准化路径(path));
        控制台输出("绝对路径: " + 获取绝对路径(path));
        控制台输出("文件类型: " + 文件类型描述(path));
        控制台输出("---");
        i = i + 1;
    }
}
```

## 技术特点

1. **完整兼容**: 实现了C++文件操作的主要功能
2. **中文接口**: 所有函数名使用中文，提高可读性
3. **freopen支持**: 特别实现了类似C++ freopen的流重定向功能
4. **路径处理**: 支持Windows和Unix风格的路径
5. **文件类型识别**: 自动识别文本和二进制文件类型
6. **错误处理**: 包含完善的错误检查和处理机制

## 实现说明

- **文件重定向**: 基于C++ freopen概念的模拟实现
- **路径处理**: 支持跨平台路径格式
- **文件类型**: 基于文件扩展名进行类型识别
- **临时文件**: 提供安全的临时文件创建机制
- **文件锁定**: 支持多进程环境下的文件同步

## 注意事项

1. **路径分隔符**: 自动处理Windows(\)和Unix(/)路径分隔符
2. **文件编码**: 文本文件默认使用UTF-8编码
3. **权限检查**: 在实际实现时需要考虑文件权限
4. **错误处理**: 所有函数都包含参数有效性检查
5. **流重定向**: 重定向操作会影响后续的所有输出

## 支持的文件模式

| 模式 | 描述 |
|------|------|
| "r" 或 "读" | 只读模式 |
| "w" 或 "写" | 只写模式（覆盖） |
| "a" 或 "追加" | 追加模式 |
| "rw" | 读写模式 |

## 最佳实践

1. **文件操作**: 使用前检查文件是否存在
2. **路径处理**: 使用标准化路径函数确保一致性
3. **重定向操作**: 及时恢复标准流，避免输出混乱
4. **临时文件**: 使用完后及时清理临时文件
5. **文件锁定**: 在多进程环境中适当使用文件锁

## 扩展性

该库采用模块化设计，便于扩展：
- 可以添加新的文件格式支持
- 可以添加压缩文件操作
- 可以添加网络文件操作
- 可以添加加密解密功能

## 兼容性

- **C++标准**: 兼容C++标准文件操作接口
- **跨平台**: 支持Windows、Linux、macOS等平台
- **文件编码**: 支持UTF-8、GBK等编码格式

---

*该文件库为 chplus 中文解释器的标准库，为开发者提供完整的文件处理和重定向能力。*